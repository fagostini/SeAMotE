#define pA 27
#define pC 24
#define pG 24
#define pT 25

static void random_sequence(int seqLen, char **sequence){
	int i, p;
	(*sequence) = (char *)calloc(seqLen, sizeof(char)+1);
	for( i=0; i<seqLen; i++){
		p = rand() % 100;
		if( p < pA ){
			strncat((*sequence), "A", 1);
		}
		else if( p < pA+pC ){
			strncat((*sequence), "C", 1);
		}
		else if( p < pA+pC+pG ){
			strncat((*sequence), "G", 1);
		}
		else{
			strncat((*sequence), "T", 1);
		}
	}
	(*sequence)[seqLen] = '\0';
}

static void create_motifs_nt(char **array, char mlen){
	int i, ii, c, cc;
	char pool[] = "ACGT";
	for( i=0; i<mlen; i++ ){
		int step = pow(4, mlen-i-1);
		c = ii = cc = 0;
		do{
			array[c++][i] = pool[ii];
			cc++;
			ii += cc < step ? 0 : 1;
			cc = cc < step ? cc : 0;
			ii = ii == 4 ? 0 : ii;
		}while( c<pow(4, mlen));
	} 	
}

static int check_motif(char *mstr, char mlen){
	int i, dash, no;
	dash = no = 0;
	for( i=0; i<mlen; i++ ){
		dash += mstr[i] == '-' ? 1 : 0;
	}
	if( (float)dash/mlen > 0.3 || (mstr[0] == '-' && mstr[mlen-1] == '-') ){
		no = 1;	
	}
	
	return no;
}

static int filter_and_expand_nt(char **oldSet, float *pcov, float *ncov, int numMot, int newLen, float threshold, char ***newSet){
	int i, ii;
	char pool[] = "ACGT-";
	char **tmpSet = calloc2Dchar(newLen, numMot*10);
	FILE *tmp_out, *tmp_in;
/*	if( (dummy = tmpfile()) == NULL ){ */
	if( (tmp_out = fopen("tmpMot.txt", "w")) == NULL ){
		printf("Fail\nCannot open the temporary file to store motifs.\n");
		exit(1);
	}
	int c = 0;
	for( i=0; i<numMot; i++ ){
		if( pcov[i]>=threshold | ncov[i]>=threshold ){
  		for( ii=0; ii<5; ii++ ){
 				char *motA = (char *)calloc(newLen, sizeof(char)+1);
 				strncpy(motA, oldSet[i], newLen-1);
 				strncat(motA, &pool[ii], 1);
 				char *motB = (char *)calloc(newLen, sizeof(char)+1);
 				strncpy(motB, &pool[ii], 1);
 				strncat(motB, oldSet[i], newLen-1);
 				if( check_motif(motA, newLen) == 0 ){
 					fprintf(tmp_out, "%s\n", motA);
 				}
 				if( check_motif(motB, newLen) == 0 ){
 					fprintf(tmp_out, "%s\n", motB);
 				}
/*  			strncpy(tmpSet[c++], motA, newLen);
  				strncpy(tmpSet[c++], motB, newLen); */
 				free(motA);
 				free(motB);
 			}
		}  
	}
	fclose(tmp_out);
	
	if( (tmp_in = fopen("tmpMot.txt", "r")) == NULL ){
		printf("Fail\nCannot open the temporary file to store motifs.\n");
		exit(1);
	}

	int numUniq = 0;
	while(!feof(tmp_in)){
		char *mot = (char *)calloc(newLen, sizeof(char)+1);
		fscanf(tmp_in,"%[^\n]%*c", mot);
		if(mot[0]!='\0'){
			int found = c = 0;
			do{
				if( strncmp(tmpSet[c++], mot, newLen) == 0 ){
					found = 1;
					break;
				}
			}while( c <= numUniq );
			if( found == 0 ){
				strncpy(tmpSet[numUniq++], mot, newLen);
			}
		}
	}
	fclose(tmp_in);
	remove("tmpMot.txt");

	c = 0;
	(*newSet) = calloc2Dchar(newLen, numUniq);
	while( c<numUniq ){
		strncpy((*newSet)[c], tmpSet[c], newLen);
		c++;
	}
	
	return numUniq;
}
